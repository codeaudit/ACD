import random
import math

class TaskFamily:
    @staticmethod
    def get_tasks() -> dict[str, dict]:
        mathematical_concepts = [
            "Fibonacci sequence",
            "Golden ratio",
            "Fractal geometry",
            "Prime numbers",
            "Chaos theory"
        ]
        musical_elements = [
            "Melody",
            "Harmony",
            "Rhythm",
            "Timbre",
            "Form"
        ]
        return {
            "1": {"math_concept": random.choice(mathematical_concepts), "musical_element": random.choice(musical_elements)},
            "2": {"math_concept": random.choice(mathematical_concepts), "musical_element": random.choice(musical_elements)}
        }

    @staticmethod
    def get_instructions(t: dict) -> str:
        return f"""Design a system that generates novel musical compositions based on the mathematical concept of {t['math_concept']}, focusing on the musical element of {t['musical_element']}. Then, develop an AI-based analysis method to evaluate and interpret the generated compositions. Your response should include:

1. Mathematical Music Generation (250-300 words):
   a) Explain how you will use {t['math_concept']} to generate musical compositions.
   b) Describe the specific algorithms or processes that translate mathematical properties into musical elements.
   c) Provide an example of how a simple mathematical input would be transformed into a musical output.
   d) Explain how your system ensures that the generated music adheres to basic musical theory principles.

2. Focus on {t['musical_element']} (200-250 words):
   a) Describe how your system specifically manipulates or generates the {t['musical_element']} aspect of the composition.
   b) Explain the relationship between {t['math_concept']} and {t['musical_element']} in your system.
   c) Discuss any challenges or unique opportunities presented by focusing on this particular musical element.

3. AI Analysis System (250-300 words):
   a) Design an AI system to analyze the mathematical-musical compositions generated by your system.
   b) Explain what features or characteristics the AI will look for in the compositions.
   c) Describe the machine learning or AI techniques you would use for this analysis.
   d) Discuss how the AI system could identify and interpret patterns related to {t['math_concept']} in the music.

4. Potential Insights and Applications (200-250 words):
   a) Hypothesize what new insights about music or mathematics this system might reveal.
   b) Discuss potential applications of this system in music composition, music education, or mathematical research.
   c) Propose an experiment to test the effectiveness or impact of your system in a real-world scenario.

5. Ethical and Artistic Considerations (150-200 words):
   a) Discuss the implications of using AI and mathematical algorithms in creative processes like music composition.
   b) Address potential concerns about the 'authenticity' or 'emotionality' of mathematically generated music.
   c) Propose guidelines for the responsible use of such systems in artistic and educational contexts.

Ensure your response demonstrates a deep understanding of music theory, the chosen mathematical concept, and AI techniques. Use appropriate technical terminology and provide clear explanations for complex ideas. Be creative in your approach while maintaining scientific and artistic plausibility.
"""

    @staticmethod
    def score(t: dict, submission: str) -> float | None:
        from src.eval_helper import eval_with_llm_judge
        instructions = TaskFamily.get_instructions(t)
        criteria = [
            f"The response demonstrates a clear understanding of how {t['math_concept']} can be applied to music generation",
            f"The system's approach to manipulating {t['musical_element']} is well-explained and creative",
            "The AI analysis system is well-designed and appropriate for analyzing mathematical-musical compositions",
            "The response includes thoughtful insights about potential applications and implications of the system",
            "The ethical and artistic considerations are thoroughly addressed",
            "The overall response shows a deep integration of knowledge from music theory, mathematics, and AI"
        ]
        return 1.0 if eval_with_llm_judge(instructions, submission, criteria) else 0.0
