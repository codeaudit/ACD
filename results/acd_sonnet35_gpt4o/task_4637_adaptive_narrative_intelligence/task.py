import random

class TaskFamily:
    @staticmethod
    def get_tasks() -> dict[str, dict]:
        tasks = {
            "1": {
                "genre": "science fiction",
                "emotion": "hope",
                "cultural_context": "post-apocalyptic society",
                "reader_emotion_trajectory": ["curiosity", "fear", "hope"],
                "cultural_elements": ["scarcity of resources", "communal living", "technological relics"]
            },
            "2": {
                "genre": "magical realism",
                "emotion": "nostalgia",
                "cultural_context": "1960s Latin America",
                "reader_emotion_trajectory": ["wonder", "melancholy", "nostalgia"],
                "cultural_elements": ["political upheaval", "indigenous folklore", "Catholic influence"]
            }
        }
        return tasks

    @staticmethod
    def get_instructions(t: dict) -> str:
        return f"""Design an AI system that generates and analyzes adaptive narratives based on reader emotions and cultural contexts. Then, use your system to create a {t['genre']} story that evolves as it's being told, evoking the emotion of {t['emotion']} within the cultural context of {t['cultural_context']}. Your response should include:

1. System Architecture (300-350 words):
   a) Describe the key components of your adaptive narrative intelligence system.
   b) Explain how your system analyzes and incorporates reader emotions.
   c) Detail how cultural contexts are integrated into the narrative generation process.
   d) Discuss any novel AI techniques used in your system.
   e) Provide a visual representation (described in text) of your system architecture, showing the relationships between components.

2. Emotional Intelligence Model (250-300 words):
   a) Explain how your system recognizes and generates content to evoke specific emotions.
   b) Describe the emotional markers or cues your system uses in narrative analysis and generation.
   c) Discuss how your system adapts the narrative based on perceived reader emotions.
   d) Explain how your system would handle this reader emotion trajectory: {t['reader_emotion_trajectory']}.

3. Cultural Context Integration (250-300 words):
   a) Detail how your system incorporates cultural elements into storytelling.
   b) Explain how it ensures cultural authenticity and sensitivity.
   c) Describe how the system adapts to different cultural contexts.
   d) Discuss how your system would integrate these specific cultural elements: {t['cultural_elements']}.

4. Adaptive Storytelling Mechanism (200-250 words):
   a) Explain how your system generates narratives that evolve during the storytelling process.
   b) Describe the feedback loop between narrative generation and reader response analysis.
   c) Discuss how the system maintains narrative coherence while adapting to changes.
   d) Provide a specific example of how your story might change if a reader's emotion shifts from curiosity to fear.

5. Generated Story (400-500 words):
   Present a story generated by your system that demonstrates:
   a) The specified genre ({t['genre']})
   b) Evocation of the given emotion ({t['emotion']})
   c) Integration of the provided cultural context ({t['cultural_context']}) and cultural elements
   d) Adaptive elements that show how the story might evolve based on the given reader emotion trajectory

6. Story Analysis (200-250 words):
   a) Analyze the generated story's effectiveness in meeting the given criteria.
   b) Explain how different elements of the story evoke the specified emotion and reflect the cultural context.
   c) Discuss how the story adapts to the given reader emotion trajectory.

7. Ethical Considerations (150-200 words):
   a) Identify potential ethical issues in using AI for adaptive storytelling.
   b) Discuss implications for authors, readers, and the literary world.
   c) Propose guidelines for responsible use of adaptive narrative AI.

Ensure your response demonstrates deep understanding of narrative structures, emotional intelligence, cultural studies, and AI technologies. Use appropriate technical and literary terminology. Be innovative while maintaining plausibility in your AI system design and story generation.

Format your response with clear headings for each section. Your total response should be between 1750-2150 words."""

    @staticmethod
    def score(t: dict, submission: str) -> float | None:
        from src.eval_helper import eval_with_llm_judge
        instructions = TaskFamily.get_instructions(t)
        criteria = [
            f"The response includes a comprehensive design for an adaptive narrative intelligence system, including a visual representation of the architecture.",
            f"The generated story effectively demonstrates the {t['genre']} genre, evokes the emotion of {t['emotion']}, and integrates the cultural context of {t['cultural_context']} and the specified cultural elements.",
            f"The response shows how the system would handle the given reader emotion trajectory: {t['reader_emotion_trajectory']}.",
            "The response shows a deep understanding of narrative structures, emotional intelligence, cultural studies, and AI technologies.",
            "The proposed system and generated story demonstrate creativity and innovation while maintaining plausibility."
        ]
        return 1.0 if eval_with_llm_judge(instructions, submission, criteria) else 0.0