import random

class TaskFamily:
    @staticmethod
    def get_tasks() -> dict[str, dict]:
        tasks = [
            {
                "culture": "Renaissance Europe",
                "musical_elements": ["modal harmony", "polyphony", "madrigals"],
                "historical_event": "Protestant Reformation"
            },
            {
                "culture": "West African",
                "musical_elements": ["polyrhythms", "call and response", "pentatonic scales"],
                "historical_event": "Trans-Atlantic Slave Trade"
            },
            {
                "culture": "Classical India",
                "musical_elements": ["raga", "tala", "alap"],
                "historical_event": "Mughal Empire Expansion"
            },
            {
                "culture": "Baroque Europe",
                "musical_elements": ["basso continuo", "counterpoint", "ornamentation"],
                "historical_event": "Scientific Revolution"
            }
        ]
        return {str(i+1): task for i, task in enumerate(random.sample(tasks, k=2))}

    @staticmethod
    def get_instructions(t: dict) -> str:
        return f"Design an AI system that simulates the evolution of musical styles and generates new compositions based on the following parameters:\n\nCulture: {t['culture']}\nMusical Elements: {', '.join(t['musical_elements'])}\nHistorical Event: {t['historical_event']}\n\nYour response should include:\n\n1. AI System Architecture (300-350 words):\n   a) Describe the key components of your AI system for music evolution and generation.\n   b) Explain how your system incorporates cultural and historical factors into music creation.\n   c) Detail the mechanisms used for ensuring musical coherence and cultural authenticity.\n   d) Discuss how your system balances creativity with historical accuracy.\n   e) Explain how your system integrates knowledge from musicology, cultural anthropology, and AI.\n\n2. Musical Evolution Model (250-300 words):\n   a) Describe how your system represents musical elements, cultural factors, and historical events.\n   b) Explain the algorithms or techniques used for simulating musical evolution and generating new compositions.\n   c) Discuss how your model handles the complexity of musical structures and cultural influences.\n   d) Address potential biases in your model and how you mitigate them.\n\n3. Generated Composition Description (200-250 words):\n   Describe a musical composition generated by your AI system, including:\n   a) How it incorporates the specified musical elements and cultural context.\n   b) Its structure, instrumentation, and key musical features.\n   c) How it reflects the influence of the given historical event.\n   d) Any innovative or unexpected elements that emerged during the generation process.\n\n4. Analysis and Interpretation (200-250 words):\n   a) Analyze the generated composition, explaining its musical and cultural significance.\n   b) Discuss how the composition reflects the evolution of musical style in the given context.\n   c) Compare aspects of your generated composition with historical musical works from the specified culture and period.\n\n5. Evaluation and Ethical Considerations (150-200 words):\n   a) Propose specific criteria for evaluating the quality and cultural authenticity of AI-generated music.\n   b) Discuss potential risks or ethical concerns of using AI for musical creation and cultural simulation.\n   c) Suggest guidelines for the responsible use of such technology in musicology or creative applications.\n   d) Address the potential impact of AI-generated music on cultural preservation and artistic expression.\n\nEnsure your response demonstrates a deep understanding of music theory, cultural anthropology, and artificial intelligence. Be creative in your system design and music generation while maintaining cultural sensitivity and historical plausibility. Use appropriate terminology from relevant fields and provide clear explanations for complex concepts.\n\nFormat your response using clear headings for each section, numbered as above. Your total response should be between 1100-1350 words."

    @staticmethod
    def score(t: dict, submission: str) -> float | None:
        from src.eval_helper import eval_with_llm_judge
        instructions = TaskFamily.get_instructions(t)
        criteria = [
            f"The response demonstrates a deep understanding of the musical elements and cultural context of {t['culture']}.",
            "The AI system design is innovative and incorporates principles from musicology, cultural anthropology, and AI.",
            f"The generated composition description credibly reflects the influence of {t['historical_event']} and incorporates the specified musical elements: {', '.join(t['musical_elements'])}.",
            "The analysis shows insight into the musical and cultural significance of the generated composition and compares it with historical works.",
            "The response addresses ethical considerations and proposes thoughtful guidelines for using AI in musical creation.",
            "The overall response is well-structured, coherent, and within the specified word count range."
        ]
        return 1.0 if eval_with_llm_judge(instructions, submission, criteria) else 0.0
