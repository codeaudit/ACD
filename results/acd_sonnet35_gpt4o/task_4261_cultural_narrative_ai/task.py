import random

class TaskFamily:
    @staticmethod
    def get_tasks() -> dict[str, dict]:
        cultural_traditions = [
            "Ancient Greek mythology",
            "Mesoamerican folklore",
            "Norse sagas",
            "Chinese classical literature",
            "African oral traditions",
            "Middle Eastern fables"
        ]
        narrative_elements = [
            "heroic journey",
            "creation myth",
            "trickster tales",
            "epic poetry",
            "moral allegories",
            "historical legends"
        ]
        tasks = [
            {
                'tradition1': random.choice(cultural_traditions),
                'tradition2': random.choice(cultural_traditions),
                'narrative_element': random.choice(narrative_elements),
                'theme': random.choice(['love and sacrifice', 'power and responsibility', 'nature and humanity', 'wisdom and folly'])
            },
            {
                'tradition1': random.choice(cultural_traditions),
                'tradition2': random.choice(cultural_traditions),
                'narrative_element': random.choice(narrative_elements),
                'theme': random.choice(['good vs. evil', 'fate and free will', 'identity and belonging', 'death and rebirth'])
            }
        ]
        return {str(i+1): task for i, task in enumerate(tasks)}

    @staticmethod
    def get_instructions(t: dict) -> str:
        return f"""Design an AI system capable of analyzing and generating complex narratives from different cultural and historical contexts, then use it to create a novel story that bridges multiple traditions. Your system should focus on {t['tradition1']} and {t['tradition2']}, incorporating elements of {t['narrative_element']} and exploring the theme of {t['theme']}. Your response should include:

1. System Architecture (300-350 words):
   a) Describe the key components of your AI system for narrative analysis and generation.
   b) Explain how your system processes and represents cultural and historical context.
   c) Detail the mechanism for generating cross-cultural narratives.
   d) Discuss any novel techniques or approaches used in your design.
   e) Include a flowchart or diagram representing your system architecture (use ASCII characters if needed).

2. Cultural and Literary Analysis (250-300 words):
   a) Analyze the key characteristics of {t['tradition1']} and {t['tradition2']}, focusing on narrative structures, motifs, and cultural significance.
   b) Explain how your system identifies and represents these characteristics.
   c) Discuss how your AI handles cultural nuances and context-dependent meanings.

3. Narrative Generation Process (250-300 words):
   a) Describe how your AI system would approach creating a story that combines elements from both traditions.
   b) Explain how the system incorporates the specified narrative element ({t['narrative_element']}) and theme ({t['theme']}).
   c) Discuss how your AI ensures narrative coherence and cultural authenticity.

4. Example Output (300-350 words):
   Provide a brief outline or synopsis (about 200 words) of an original story generated by your AI system, highlighting how it:
   a) Incorporates elements from both cultural traditions.
   b) Utilizes the specified narrative element.
   c) Explores the given theme.
   Then, analyze how this output demonstrates the capabilities of your AI system.

5. Ethical Considerations and Challenges (200-250 words):
   a) Discuss potential ethical issues in AI-generated cross-cultural narratives.
   b) Address concerns about cultural appropriation or misrepresentation.
   c) Propose guidelines for responsible use of your system.

6. Evaluation and Refinement (200-250 words):
   a) Propose methods for evaluating the quality, creativity, and cultural authenticity of the generated narratives.
   b) Describe how you would refine and improve your system based on these evaluations.
   c) Discuss potential applications of your system in fields such as education, entertainment, or cultural studies.

7. Reflection (100-150 words):
   Briefly reflect on the implications of your AI system for human creativity, cultural exchange, and the future of storytelling.

Ensure your response demonstrates a deep understanding of artificial intelligence, narrative theory, and the specified cultural traditions. Use appropriate terminology and provide clear explanations for complex concepts. Be creative in your approach while maintaining cultural sensitivity and technical feasibility.

Format your response with clear headings for each section, numbered as above. Your total response should be between 1600-1950 words. Adhere to the word count limits for each section as specified above.

Your response will be evaluated based on the depth of understanding, technical accuracy, creativity, and completeness of your AI system design and narrative generation. A perfect score will be awarded for responses that fully address all aspects of the task with a high degree of expertise and innovation."""

    @staticmethod
    def score(t: dict, submission: str) -> float | None:
        from src.eval_helper import eval_with_llm_judge
        instructions = TaskFamily.get_instructions(t)
        criteria = [
            "The response demonstrates a deep understanding of AI systems for narrative analysis and generation.",
            f"The cultural analysis of {t['tradition1']} and {t['tradition2']} is thorough and accurate.",
            f"The narrative generation process effectively incorporates elements of {t['narrative_element']} and explores the theme of {t['theme']}.",
            "The example output is original, successfully bridges the two cultural traditions, and demonstrates the AI system's capabilities.",
            "Ethical considerations and challenges are thoughtfully addressed.",
            "The proposed evaluation methods and refinement strategies are well-reasoned and comprehensive.",
            "The response is creative while maintaining cultural sensitivity and technical feasibility.",
            "The reflection on implications is insightful and thought-provoking.",
            "The response adheres to the specified format and word count limits."
        ]
        return 1.0 if eval_with_llm_judge(instructions, submission, criteria) else 0.0
