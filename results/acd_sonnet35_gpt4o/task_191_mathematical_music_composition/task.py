import random

class TaskFamily:
    @staticmethod
    def get_tasks() -> dict[str, dict]:
        mathematical_concepts = [
            {
                'concept': 'Fibonacci sequence',
                'musical_element': 'rhythm',
                'emotion': 'curiosity'
            },
            {
                'concept': 'Golden ratio',
                'musical_element': 'melody',
                'emotion': 'awe'
            }
        ]
        
        return {str(i+1): concept for i, concept in enumerate(random.sample(mathematical_concepts, 2))}

    @staticmethod
    def get_instructions(t: dict) -> str:
        return f"""Design an AI system that generates novel musical compositions based on mathematical principles and analyzes their emotional impact. Your task has three parts:

1. System Design (300-350 words):
Create an AI system that generates musical compositions using the {t['concept']} as its primary mathematical principle, focusing on the {t['musical_element']} aspect of the music. Your system should:
a) Explain how the {t['concept']} is translated into musical {t['musical_element']}.
b) Describe the AI algorithms or techniques used to generate the composition.
c) Outline how the system ensures musical coherence and aesthetics while adhering to the mathematical principle.

2. Composition Analysis (250-300 words):
Analyze a hypothetical composition generated by your system, addressing:
a) How the {t['concept']} is manifested in the {t['musical_element']} of the piece.
b) The musical structure and any emerging patterns.
c) Potential emotional responses to the composition, with a focus on evoking a sense of {t['emotion']}.

3. Emotional Impact Evaluation (250-300 words):
Propose a method to evaluate the emotional impact of the generated composition, particularly its effectiveness in evoking {t['emotion']}. Include:
a) Specific techniques or technologies for measuring emotional responses.
b) How to account for individual differences in musical perception and emotional reactions.
c) Potential challenges in quantifying emotional impact and proposed solutions.

Ensure your response demonstrates a deep understanding of music theory, the specified mathematical concept, AI technologies, and emotional psychology. Be creative in your approach while maintaining scientific and technological plausibility.

Format your response using the following structure:

1. System Design:
   [Your explanation here]

2. Composition Analysis:
   [Your analysis here]

3. Emotional Impact Evaluation:
   [Your evaluation method here]

Your total response should be between 800-950 words."""

    @staticmethod
    def score(t: dict, submission: str) -> float | None:
        from src.eval_helper import eval_with_llm_judge
        instructions = TaskFamily.get_instructions(t)
        criteria = [
            f"The system design clearly explains how {t['concept']} is used to generate {t['musical_element']}.",
            "The AI algorithms and techniques for composition generation are well-described and plausible.",
            f"The composition analysis demonstrates how {t['concept']} manifests in the {t['musical_element']} and discusses potential emotional responses, focusing on {t['emotion']}.",
            f"The emotional impact evaluation method is well-thought-out and addresses how to measure {t['emotion']} responses to the composition.",
            "The response shows a strong understanding of music theory, mathematics, AI, and emotional psychology."
        ]
        return 1.0 if eval_with_llm_judge(instructions, submission, criteria) else 0.0
